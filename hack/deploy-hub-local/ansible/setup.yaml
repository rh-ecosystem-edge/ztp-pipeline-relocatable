---
- hosts: all
  user: root

  vars:
    console_keymap: en
    console_font: eurlatgr
    system_locale: en_US.UTF-8
    system_timezone: Europe/Madrid
    root_shell: /bin/bash
    domain: "{{ ansible_nodename.split('.')[1:] | join('.') }}"
    keys:
      - key: "{{ sshkey }}"

  tasks:
    - name: Base configuration
      include_tasks: tasks/base/00-base.yaml

    - name: Install rpm and configure common services
      include_tasks: tasks/base/01-services.yaml

    - name: Install bin-utils
      include_tasks: tasks/base/02-bin-utils.yaml

    - name: Configure sshd
      include_tasks: "{{item}}"
      with_fileglob:
        - "tasks/services/sshd/*.yaml"
      when: configuressh==True

    - name: Configure chronyd
      include_tasks: "{{item}}"
      with_fileglob:
        - "tasks/services/chronyd/*.yaml"
      when: configurechronyd==True

    - name: Configure libvirtd
      include_tasks: "{{item}}"
      with_fileglob:
        - "tasks/services/libvirtd/*.yaml"

    - name: Flush handlers
      meta: flush_handlers

  handlers:
    - name: Restart monit
      service:
        name: monit
        state: restarted
      when: monit

    - name: Restart systemd
      shell: systemctl daemon-reload

    - name: Restart sshd
      service:
        name: sshd
        state: restarted

    - name: Restart tuned
      service:
        name: tuned
        state: restarted

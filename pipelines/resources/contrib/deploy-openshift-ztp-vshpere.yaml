apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: deploy-openshift-ztp-vshpere
  annotations:
    description: |
      This task will configure the server to deploy OpenShift via ZTP (Zero-Touch Provisioning) to vSphere. See https://github.com/Red-Hat-SE-RTO/openshift-ztp for more info.
spec:
  workspaces:
    - name: ztp
  params:
    - name: ztp-container-image
      type: string
      default: "quay.io/ztpfw/pipeline:latest"
    - name: kubeconfig
      type: string
      default: ""
    - name: edgeclusters-config
      type: string
      default: ""
    - name: mock
      type: string
      default: "false"
  stepTemplate:
    env:
      - name: WORKDIR
        value: "/workspace/ztp"
      - name: EDGECLUSTERS_CONFIG
        value: $(params.edgeclusters-config)
      - name: KUBECONFIG
        value: "$(workspaces.ztp.path)/kubeconfig"
      - name: DEPLOY_AAP_DIR
        value: "contrib/deploy-aap"
      - name: SHARED_DIR
        value: "shared-utils"
  steps:
    # Deploy HTTPD Server
    - name: deploy-httpd-server
      taskRef:
        name: hub-deploy-httpd-server
      params:
        - name: edgeclusters-config
          value: $(params.edgeclusters-config)
        - name: kubeconfig
          value: $(params.kubeconfig)
        - name: ztp-container-image
          value: $(params.ztp-container-image)
        - name: mock
          value: $(params.mock)
      runAfter:
        - pre-flight
      workspaces:
        - name: ztp
          workspace: ztp

    # Deploy Disconnected Registry + Sync
    - name: deploy-disconnected-registry
      taskRef:
        name: hub-deploy-disconnected-registry
      params:
        - name: edgeclusters-config
          value: $(params.edgeclusters-config)
        - name: kubeconfig
          value: $(params.kubeconfig)
        - name: ztp-container-image
          value: $(params.ztp-container-image)
        - name: mock
          value: $(params.mock)
      runAfter:
        - deploy-httpd-server
      workspaces:
        - name: ztp
          workspace: ztp

    # Deploy RHACM
    - name: deploy-acm
      taskRef:
        name: hub-deploy-acm
      params:
        - name: edgeclusters-config
          value: $(params.edgeclusters-config)
        - name: kubeconfig
          value: $(params.kubeconfig)
        - name: ztp-container-image
          value: $(params.ztp-container-image)
        - name: mock
          value: $(params.mock)
      runAfter:
        - deploy-disconnected-registry
      workspaces:
        - name: ztp
          workspace: ztp

    - name: deploy-aap
      image: "$(params.ztp-container-image)"
      imagePullPolicy: Always
      script: |
        #!/usr/bin/bash

        if [[ "${MOCK}" == 'false' ]]; then
          cd ${WORKDIR}/${DEPLOY_AAP_DIR}
          ./deploy.sh
        else
          echo "Deploy AAP: Mock mode on"
        fi

  volumes:
  - name: lib-containers
    emptyDir: {}
